const ShadUI = (() => {
    const getTarget = (el) => {
        const targetSelector = el.getAttribute('data-ui-target');
        return document.querySelector(targetSelector);
    };
    const trapFocus = (element) => {
        const focusableEls = element.querySelectorAll(
            'a[href], button, textarea, input[type="text"], input[type="radio"], input[type="checkbox"], select, .tabindex-0'
        );
        if (!focusableEls.length) return;
        const firstFocusableEl = focusableEls[0];
        const lastFocusableEl = focusableEls[focusableEls.length - 1];
        element.addEventListener('keydown', function (e) {
            const isTabPressed = e.key === 'Tab' || e.keyCode === 9;
            if (!isTabPressed) return;
            if (e.shiftKey) { 
                if (document.activeElement === firstFocusableEl) {
                    lastFocusableEl.focus();
                    e.preventDefault();
                }
            } else { 
                if (document.activeElement === lastFocusableEl) {
                    firstFocusableEl.focus();
                    e.preventDefault();
                }
            }
        });
        firstFocusableEl.focus();
    };
    const lockBodyScroll = () => {
        const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = `${scrollBarWidth}px`;
    };
    const unlockBodyScroll = () => {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    };
    const closeAllModals = () => {
        let closedAny = false;
        document.querySelectorAll('.modal-overlay.open, .drawer-overlay.open').forEach(el => {
            el.classList.remove('open');
            closedAny = true;
        });
        if (closedAny) unlockBodyScroll();
    };
    const closeAllDropdowns = () => {
        document.querySelectorAll('.dropdown-menu.open, .popover.open, .select-dropdown.open').forEach(el => el.classList.remove('open'));
    };
    let isInitialized = false;
    const init = () => {
        if (isInitialized) return;
        isInitialized = true;
        document.addEventListener('click', (e) => {
            const modalBtn = e.target.closest('[data-ui-toggle="modal"], [data-ui-toggle="drawer"]');
            if (modalBtn) {
                e.preventDefault();
                const target = getTarget(modalBtn);
                if (target) {
                    target.classList.add('open');
                    target.setAttribute('aria-hidden', 'false');
                    lockBodyScroll();
                    trapFocus(target);
                }
                return;
            }
            const dismissBtn = e.target.closest('[data-ui-dismiss="modal"], [data-ui-dismiss="drawer"]');
            if (dismissBtn) {
                e.preventDefault();
                const overlay = dismissBtn.closest('.modal-overlay') || dismissBtn.closest('.drawer-overlay');
                if (overlay) {
                    overlay.classList.remove('open');
                    unlockBodyScroll();
                }
                return;
            }
            if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('drawer-overlay')) {
                e.target.classList.remove('open');
                unlockBodyScroll();
                return;
            }
            const dropdownBtn = e.target.closest('[data-ui-toggle="dropdown"], [data-ui-toggle="popover"]');
            if (dropdownBtn) {
                e.preventDefault();
                e.stopPropagation();
                const target = getTarget(dropdownBtn) || dropdownBtn.nextElementSibling;
                if (!target) return;
                const isOpen = target.classList.contains('open');
                closeAllDropdowns();
                if (!isOpen) {
                    target.classList.add('open');
                }
                return;
            }
            if (!e.target.closest('.dropdown') && !e.target.closest('.popover-group') && !e.target.closest('.select-group')) {
                closeAllDropdowns();
            }
            const selectBtn = e.target.closest('[data-ui-toggle="select"]');
            if (selectBtn) {
                e.preventDefault();
                e.stopPropagation();
                const selectGroup = selectBtn.closest('.select-group');
                const target = selectGroup ? selectGroup.querySelector('.select-dropdown') : null;
                if (!target) return;
                const isOpen = target.classList.contains('open');
                closeAllDropdowns();
                if (!isOpen) {
                    target.classList.add('open');
                }
                return;
            }
            const selectItem = e.target.closest('.select-item');
            if (selectItem) {
                e.preventDefault();
                const selectGroup = selectItem.closest('.select-group');
                if (!selectGroup) return;
                const trigger = selectGroup.querySelector('.select-trigger .select-value');
                const hiddenInput = selectGroup.querySelector('input[type="hidden"]');
                selectGroup.querySelectorAll('.select-item').forEach(item => {
                    item.removeAttribute('data-selected');
                    const indicator = item.querySelector('.select-indicator');
                    if (indicator) indicator.innerHTML = '';
                });
                selectItem.setAttribute('data-selected', 'true');
                const checkIcon = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                let indicator = selectItem.querySelector('.select-indicator');
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'select-indicator';
                    selectItem.prepend(indicator);
                }
                indicator.innerHTML = checkIcon;
                if (trigger) {
                    trigger.textContent = selectItem.textContent.trim();
                    trigger.closest('.select-trigger').removeAttribute('data-placeholder');
                }
                if (hiddenInput) {
                    hiddenInput.value = selectItem.getAttribute('data-value');
                }
                closeAllDropdowns();
                return;
            }
            const tabBtn = e.target.closest('[data-ui-toggle="tab"]');
            if (tabBtn) {
                e.preventDefault();
                const target = getTarget(tabBtn);
                if (!target) return;
                const tabsGroup = tabBtn.closest('.tabs');
                if (!tabsGroup) return;
                const tabButtons = tabsGroup.querySelectorAll('[data-ui-toggle="tab"]');
                tabButtons.forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                    t.tabIndex = -1;
                });
                tabBtn.classList.add('active');
                tabBtn.setAttribute('aria-selected', 'true');
                tabBtn.tabIndex = 0;
                tabsGroup.querySelectorAll('.tabs-content').forEach(c => {
                    c.classList.remove('active');
                    c.classList.add('hidden');
                });
                target.classList.add('active');
                target.classList.remove('hidden');
                target.setAttribute('aria-hidden', 'false');
                return;
            }
            const accordionBtn = e.target.closest('[data-ui-toggle="accordion"]');
            if (accordionBtn) {
                e.preventDefault();
                const content = accordionBtn.nextElementSibling;
                if (!content || !content.classList.contains('accordion-content')) return;
                const isOpen = content.classList.contains('open');
                const accordion = accordionBtn.closest('.accordion');
                if (accordion && accordion.getAttribute('data-ui-accordion-type') === 'single') {
                    accordion.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('open'));
                    accordion.querySelectorAll('.accordion-trigger').forEach(b => b.setAttribute('aria-expanded', 'false'));
                }
                if (!isOpen) {
                    content.classList.add('open');
                    accordionBtn.setAttribute('aria-expanded', 'true');
                } else {
                    content.classList.remove('open');
                    accordionBtn.setAttribute('aria-expanded', 'false');
                }
                return;
            }
            const collapseBtn = e.target.closest('[data-ui-toggle="collapse"]');
            if (collapseBtn) {
                e.preventDefault();
                const target = getTarget(collapseBtn);
                if (target) {
                    target.classList.toggle('open');
                    collapseBtn.setAttribute('aria-expanded', target.classList.contains('open'));
                }
                return;
            }
            const switchBtn = e.target.closest('.switch');
            if (switchBtn && !e.target.closest('input')) { // prevent conflict if wrap an input
                e.preventDefault();
                switchBtn.classList.toggle('checked');
                const isChecked = switchBtn.classList.contains('checked');
                switchBtn.setAttribute('aria-checked', isChecked);
                switchBtn.dispatchEvent(new CustomEvent('change', { detail: { checked: isChecked } }));
                return;
            }
            const dismissElem = e.target.closest('[data-ui-dismiss="alert"], [data-ui-dismiss="chip"]');
            if (dismissElem) {
                e.preventDefault();
                const parent = dismissElem.closest('.alert, .chip');
                if (parent) {
                    parent.style.opacity = '0';
                    setTimeout(() => parent.remove(), 200);
                }
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAllModals();
                closeAllDropdowns();
            }
            if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('switch')) {
                e.preventDefault();
                e.target.click();
            }
            if (e.target.hasAttribute('data-ui-toggle') && e.target.getAttribute('data-ui-toggle') === 'tab') {
                const tabsGroup = e.target.closest('.tabs-list');
                if (tabsGroup) {
                    const tabs = Array.from(tabsGroup.querySelectorAll('[data-ui-toggle="tab"]'));
                    const currentIndex = tabs.indexOf(e.target);
                    let nextIndex = null;
                    if (e.key === 'ArrowRight') {
                        nextIndex = currentIndex === tabs.length - 1 ? 0 : currentIndex + 1;
                    } else if (e.key === 'ArrowLeft') {
                        nextIndex = currentIndex === 0 ? tabs.length - 1 : currentIndex - 1;
                    }
                    if (nextIndex !== null) {
                        e.preventDefault();
                        tabs[nextIndex].focus();
                        tabs[nextIndex].click(); // Activate immediately mimicking ShadCN setup
                    }
                }
            }
            if (e.target.hasAttribute('data-ui-toggle') && e.target.getAttribute('data-ui-toggle') === 'accordion') {
                const accordionGroup = e.target.closest('.accordion');
                if (accordionGroup) {
                    const triggers = Array.from(accordionGroup.querySelectorAll('[data-ui-toggle="accordion"]'));
                    const currentIndex = triggers.indexOf(e.target);
                    let nextIndex = null;
                    if (e.key === 'ArrowDown') {
                        nextIndex = currentIndex === triggers.length - 1 ? 0 : currentIndex + 1;
                    } else if (e.key === 'ArrowUp') {
                        nextIndex = currentIndex === 0 ? triggers.length - 1 : currentIndex - 1;
                    } else if (e.key === 'Home') {
                        nextIndex = 0;
                    } else if (e.key === 'End') {
                        nextIndex = triggers.length - 1;
                    }
                    if (nextIndex !== null) {
                        e.preventDefault();
                        triggers[nextIndex].focus();
                    }
                }
            }
        });
        initTheme();
    };
    const initTheme = () => {
        const savedTheme = localStorage.getItem('shadui-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
        }
    };
    const toastContainerId = 'shadui-toast-container';
    const createToastContainer = () => {
        let container = document.getElementById(toastContainerId);
        if (!container) {
            container = document.createElement('div');
            container.id = toastContainerId;
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
        return container;
    };
    const toast = ({ title, description, variant = 'default', duration = 3000 }) => {
        const container = createToastContainer();
        const t = document.createElement('div');
        t.className = `toast toast-${variant}`;
        let html = `<div>`;
        if (title) html += `<div class="alert-title">${title}</div>`;
        if (description) html += `<div class="alert-desc">${description}</div>`;
        html += `</div>`;
        html += `<button class="btn btn-ghost p-1" style="height:auto; min-width:auto" aria-label="Close" onclick="this.parentElement.remove()">&times;</button>`;
        t.innerHTML = html;
        container.appendChild(t);
        if (duration > 0) {
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateY(10px)';
                t.style.transition = 'all 0.3s ease';
                setTimeout(() => t.remove(), 300);
            }, duration);
        }
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    return {
        init,
        toast,
        toggleTheme: () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('shadui-theme', newTheme);
        }
    };
})();
window.ShadUI = ShadUI;

